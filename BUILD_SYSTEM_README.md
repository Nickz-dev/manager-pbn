# PBN Manager - Система сборки сайтов

## Обзор

Обновленная система сборки PBN Manager теперь включает:

- ✅ Правильное отображение прогресса сборки
- ✅ Формирование слогов для статей
- ✅ Скачивание и обработка изображений
- ✅ Отображение только категорий выбранных статей
- ✅ Базовый футер для шаблонов
- ✅ Использование скачанных изображений в карточках статей

## Основные компоненты

### 1. Страница генерации (`app/sites/generate/page.tsx`)

**Новые возможности:**
- Отображение количества собранных страниц
- Отображение количества скачанных изображений
- Предварительный просмотр слогов статей
- Отображение только категорий выбранных статей
- Детальная статистика сборки

**Шаги сборки:**
1. Подготовка данных
2. Скачивание изображений
3. Формирование слогов статей
4. Генерация контента
5. Сборка Astro
6. Обновление статуса

### 2. API сборки (`app/api/sites/build/route.ts`)

**Новые функции:**
- Автоматическое формирование слогов из заголовков статей
- Скачивание изображений в локальную папку
- Возврат статистики о количестве страниц и изображений
- Проверка результатов сборки

### 3. Генерация данных Astro (`scripts/generate-astro-data.js`)

**Улучшения:**
- Функция `generateSlug()` для создания SEO-friendly URL
- Обработка различных типов изображений (base64, URL, Strapi Media)
- Фильтрация категорий только из выбранных статей
- Статистика обработки изображений

### 4. Шаблоны Astro

**Обновления:**
- Базовый футер на всех страницах
- Правильное отображение скачанных изображений
- Fallback для отсутствующих изображений
- Адаптивный дизайн

## Использование

### 1. Создание нового сайта

1. Перейдите на `/sites/new`
2. Выберите тип сайта (PBN или Brand)
3. Выберите шаблон
4. Выберите статьи для сайта
5. Настройте SEO параметры
6. Нажмите "Создать сайт"

### 2. Генерация сайта

1. На странице `/sites/generate?siteId=XXX`
2. Проверьте предварительный просмотр
3. Убедитесь в правильности слогов статей
4. Запустите сборку
5. Следите за прогрессом в реальном времени

### 3. Результат сборки

После успешной сборки вы получите:
- Статический сайт в папке `templates/[template]/dist/`
- Скачанные изображения в `public/images/`
- Сформированные слаги для всех статей
- Статистику сборки

## Структура данных

### Статья
```json
{
  "id": "1",
  "title": "Заголовок статьи",
  "slug": "zagolovok-stati",
  "excerpt": "Краткое описание",
  "content": "Полный контент статьи",
  "featured_image": "/images/featured_1_1234567890.jpg",
  "categories": [
    {
      "name": "Категория",
      "slug": "kategoriya"
    }
  ],
  "author": {
    "name": "Автор"
  }
}
```

### Сайт
```json
{
  "site": {
    "name": "Название сайта",
    "description": "Описание",
    "domain": "example.com",
    "template": "casino-blog",
    "categories": ["Категория 1", "Категория 2"]
  },
  "articles": [...],
  "buildInfo": {
    "articleCount": 10,
    "categoryCount": 3
  }
}
```

## Тестирование

Запустите тест системы сборки:

```bash
node scripts/test-build-system.js
```

## Устранение неполадок

### Проблемы с изображениями
- Проверьте доступность URL изображений
- Убедитесь в наличии папки `public/images/`
- Проверьте права доступа к файловой системе

### Проблемы со слагами
- Убедитесь, что заголовки статей не пустые
- Проверьте кодировку символов
- Слаги генерируются автоматически из заголовков

### Проблемы со сборкой
- Проверьте наличие Node.js и npm
- Убедитесь в установке зависимостей Astro
- Проверьте логи сборки в консоли

## Конфигурация

### Переменные окружения
```env
STRAPI_URL=http://localhost:1337
STRAPI_TOKEN=your-strapi-token
```

### Настройки шаблонов
Каждый шаблон может иметь свои настройки в `templates/[template]/astro.config.mjs`

## Разработка

### Добавление нового шаблона
1. Создайте папку в `templates/`
2. Добавьте конфигурацию в `getTemplateDirectory()`
3. Создайте базовые страницы (index.astro, [slug].astro)
4. Обновите стили и компоненты

### Расширение функциональности
- Добавьте новые поля в структуру данных
- Обновите API для обработки новых полей
- Расширьте шаблоны для отображения новых данных

## Производительность

- Изображения скачиваются асинхронно
- Слаги кэшируются для повторного использования
- Сборка выполняется в фоновом режиме
- Статистика обновляется в реальном времени 